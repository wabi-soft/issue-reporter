{# @var plugin \wabisoft\craftissuereporter\IssueReporter #}
{# @var settings \wabisoft\craftissuereporter\models\Settings #}

{% import '_includes/forms.twig' as forms %}

{% set configOverrides = craft.app.config.getConfigFromFile('issue-reporter') %}

{% macro configWarning() -%}
    This is being overridden by your <code>config/issue-reporter.php</code> file.
{%- endmacro %}

{% from _self import configWarning %}

<h2>IssueRelay Credentials</h2>
<p class="light">Copy these from your <a href="https://issuerelay.com" target="_blank">IssueRelay</a> project settings.</p>

{{ forms.autosuggestField({
    label: 'Host URL',
    name: 'hostUrl',
    suggestEnvVars: true,
    value: settings.hostUrl,
    placeholder: '$ISSUE_RELAY_HOST_URL',
    required: true,
    errors: settings.getErrors('hostUrl'),
    disabled: configOverrides.hostUrl is defined,
    warning: configOverrides.hostUrl is defined ? configWarning(),
}) }}

{{ forms.autosuggestField({
    label: 'Project UUID',
    name: 'projectUuid',
    suggestEnvVars: true,
    value: settings.projectUuid,
    placeholder: '$ISSUE_RELAY_PROJECT_UUID',
    required: true,
    errors: settings.getErrors('projectUuid'),
    disabled: configOverrides.projectUuid is defined,
    warning: configOverrides.projectUuid is defined ? configWarning(),
}) }}

{{ forms.autosuggestField({
    label: 'API Secret',
    instructions: 'Used to sign widget tokens. Use an environment variable to avoid storing secrets in the database.',
    name: 'apiSecret',
    suggestEnvVars: true,
    value: settings.apiSecret,
    placeholder: '$ISSUE_RELAY_API_SECRET',
    required: true,
    errors: settings.getErrors('apiSecret'),
    disabled: configOverrides.apiSecret is defined,
    warning: configOverrides.apiSecret is defined ? configWarning(),
}) }}

<hr>

<h2>Widget Settings</h2>

{{ forms.booleanMenuField({
    label: 'Auto-inject Widget',
    instructions: 'Automatically add the widget to all front-end pages for logged-in CP users. When off, use `{{ issueRelayWidget() }}` in your templates.',
    name: 'autoInject',
    includeEnvVars: true,
    value: settings.autoInject,
    disabled: configOverrides.autoInject is defined,
    warning: configOverrides.autoInject is defined ? configWarning(),
}) }}

{{ forms.booleanMenuField({
    label: 'Include Craft Context',
    instructions: 'Send Craft environment info and request context with issue submissions. Helps AI analysis diagnose issues more accurately.',
    id: 'includeCraftContext',
    name: 'includeCraftContext',
    includeEnvVars: true,
    value: settings.includeCraftContext,
    disabled: configOverrides.includeCraftContext is defined,
    warning: configOverrides.includeCraftContext is defined ? configWarning(),
}) }}

{{ forms.autosuggestField({
    label: 'Token TTL (seconds)',
    instructions: 'How long widget tokens remain valid. Default: 3600 (1 hour).',
    name: 'tokenTtl',
    suggestEnvVars: true,
    value: settings.tokenTtl,
    size: 10,
    errors: settings.getErrors('tokenTtl'),
    disabled: configOverrides.tokenTtl is defined,
    warning: configOverrides.tokenTtl is defined ? configWarning(),
}) }}

{% set userGroupOptions = craft.app.userGroups.getAllGroups() | map(g => { label: g.name, value: g.uid }) %}
{% if userGroupOptions | length %}
    {% set allOptions = [{ label: 'Admins', value: '__admins__' }] | merge(userGroupOptions) %}
    {% set allValues = settings.allowedUserGroups %}
    {{ forms.checkboxSelectField({
        label: 'Allowed User Groups',
        instructions: 'Leave empty to allow all logged-in CP users.',
        name: 'allowedUserGroups',
        values: allValues,
        options: allOptions,
        disabled: configOverrides.allowedUserGroups is defined,
        warning: configOverrides.allowedUserGroups is defined ? configWarning(),
    }) }}
{% endif %}

<hr>
<h2>Widget Theme</h2>
<p class="light">Optional. Overrides the project theme set in the IssueRelay dashboard.</p>

{{ forms.colorField({
    label: 'Primary Color',
    name: 'primaryColor',
    value: settings.primaryColor,
    errors: settings.getErrors('primaryColor'),
    disabled: configOverrides.primaryColor is defined,
    warning: configOverrides.primaryColor is defined ? configWarning(),
}) }}

{{ forms.colorField({
    label: 'Primary Hover Color',
    name: 'primaryHoverColor',
    value: settings.primaryHoverColor,
    errors: settings.getErrors('primaryHoverColor'),
    disabled: configOverrides.primaryHoverColor is defined,
    warning: configOverrides.primaryHoverColor is defined ? configWarning(),
}) }}

<hr>
<h2>Log Settings</h2>

{{ forms.editableTableField({
    label: 'Log Files',
    instructions: 'Log filenames from `storage/logs/` to include with issue submissions. Supports wildcards (`web-*.log`, `console-*.log`). Only files modified in the last 48 hours are included. Remove all rows to disable.',
    id: 'logFiles',
    name: 'logFiles',
    cols: {
        pattern: {
            type: 'singleline',
            heading: 'Pattern',
        },
    },
    rows: settings.logFiles,
    allowAdd: true,
    allowDelete: true,
    allowReorder: true,
    addRowLabel: 'Add a pattern',
    errors: settings.getErrors('logFiles'),
    disabled: configOverrides.logFiles is defined,
    warning: configOverrides.logFiles is defined ? configWarning(),
}) }}

{{ forms.autosuggestField({
    label: 'Max Log Files',
    instructions: 'Maximum number of log files to include (min 1 / max 10). Most recent files are prioritized.',
    name: 'maxLogFiles',
    suggestEnvVars: true,
    value: settings.maxLogFiles,
    size: 5,
    errors: settings.getErrors('maxLogFiles'),
    disabled: configOverrides.maxLogFiles is defined,
    warning: configOverrides.maxLogFiles is defined ? configWarning(),
}) }}

{{ forms.autosuggestField({
    label: 'Max File Read Size (KB)',
    instructions: 'Kilobytes to read from the tail of each log file (min 8 / max 64). Keeps memory usage predictable during collection.',
    name: 'maxLogFileSize',
    suggestEnvVars: true,
    value: settings.maxLogFileSize,
    size: 10,
    errors: settings.getErrors('maxLogFileSize'),
    disabled: configOverrides.maxLogFileSize is defined,
    warning: configOverrides.maxLogFileSize is defined ? configWarning(),
}) }}

{{ forms.autosuggestField({
    label: 'Max Total Log Size',
    instructions: 'Maximum total characters across all log files in the payload (min 2,000 / max 50,000). Prevents oversized submissions to IssueRelay.',
    name: 'maxTotalLogSize',
    suggestEnvVars: true,
    value: settings.maxTotalLogSize,
    size: 10,
    errors: settings.getErrors('maxTotalLogSize'),
    disabled: configOverrides.maxTotalLogSize is defined,
    warning: configOverrides.maxTotalLogSize is defined ? configWarning(),
}) }}
