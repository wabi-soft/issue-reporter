{# @var plugin \wabisoft\craftissuereporter\IssueReporter #}
{# @var settings \wabisoft\craftissuereporter\models\Settings #}

{% import '_includes/forms.twig' as forms %}

<h2>IssueRelay Credentials</h2>
<p class="light">Copy these from your <a href="https://issuerelay.com" target="_blank">IssueRelay</a> project settings.</p>

{{ forms.textField({
    label: 'Host URL',
    name: 'hostUrl',
    value: settings.hostUrl,
    placeholder: 'https://issuerelay.com',
    required: true,
    errors: settings.getErrors('hostUrl'),
}) }}

{{ forms.textField({
    label: 'Project UUID',
    name: 'projectUuid',
    value: settings.projectUuid,
    required: true,
    errors: settings.getErrors('projectUuid'),
}) }}

{{ forms.passwordField({
    label: 'API Secret',
    instructions: 'Used to sign widget tokens. For production, use `$ENV_VAR` syntax.',
    name: 'apiSecret',
    value: settings.apiSecret,
    required: true,
    errors: settings.getErrors('apiSecret'),
}) }}

<hr>

<h2>Widget Settings</h2>

{{ forms.lightswitchField({
    label: 'Auto-inject Widget',
    instructions: 'Automatically add the widget to all front-end pages for logged-in CP users. When off, use `{{ issueRelayWidget() }}` in your templates.',
    name: 'autoInject',
    on: settings.autoInject,
}) }}

{{ forms.textField({
    label: 'Token TTL (seconds)',
    instructions: 'How long widget tokens remain valid. Default: 3600 (1 hour).',
    name: 'tokenTtl',
    value: settings.tokenTtl,
    type: 'number',
    size: 10,
    errors: settings.getErrors('tokenTtl'),
}) }}

{% set userGroupOptions = craft.app.userGroups.getAllGroups() | map(g => { label: g.name, value: g.uid }) %}
{% if userGroupOptions | length %}
    {{ forms.checkboxSelectField({
        label: 'Allowed User Groups',
        instructions: 'Leave empty to allow all logged-in CP users.',
        name: 'allowedUserGroups',
        values: settings.allowedUserGroups,
        options: userGroupOptions,
    }) }}
{% endif %}

<hr>
<h2>Widget Theme</h2>
<p class="light">Optional. Overrides the project theme set in the IssueRelay dashboard.</p>

{{ forms.colorField({
    label: 'Primary Color',
    name: 'primaryColor',
    value: settings.primaryColor,
    errors: settings.getErrors('primaryColor'),
}) }}

{{ forms.colorField({
    label: 'Primary Hover Color',
    name: 'primaryHoverColor',
    value: settings.primaryHoverColor,
    errors: settings.getErrors('primaryHoverColor'),
}) }}

<hr>
<h2>Log Settings</h2>

{{ forms.editableTableField({
    label: 'Log Files',
    instructions: 'Log filenames from `storage/logs/` to include with issue submissions. Supports wildcards (`web-*.log`, `console-*.log`). Only files modified in the last 48 hours are included. Remove all rows to disable.',
    id: 'logFiles',
    name: 'logFiles',
    cols: {
        pattern: {
            type: 'singleline',
            heading: 'Pattern',
        },
    },
    rows: settings.logFiles,
    allowAdd: true,
    allowDelete: true,
    allowReorder: true,
    addRowLabel: 'Add a pattern',
    errors: settings.getErrors('logFiles'),
}) }}

{{ forms.textField({
    label: 'Max Log Files',
    instructions: 'Maximum number of log files to include (min 1 / max 10). Most recent files are prioritized.',
    name: 'maxLogFiles',
    value: settings.maxLogFiles,
    type: 'number',
    size: 5,
    min: 1,
    max: 10,
    errors: settings.getErrors('maxLogFiles'),
}) }}

{{ forms.textField({
    label: 'Max File Read Size (KB)',
    instructions: 'Kilobytes to read from the tail of each log file (min 8 / max 64). Keeps memory usage predictable during collection.',
    name: 'maxLogFileSize',
    value: settings.maxLogFileSize,
    type: 'number',
    size: 10,
    min: 8,
    max: 64,
    errors: settings.getErrors('maxLogFileSize'),
}) }}

{{ forms.textField({
    label: 'Max Total Log Size',
    instructions: 'Maximum total characters across all log files in the payload (min 2,000 / max 50,000). Prevents oversized submissions to IssueRelay.',
    name: 'maxTotalLogSize',
    value: settings.maxTotalLogSize,
    type: 'number',
    size: 10,
    min: 2000,
    max: 50000,
    errors: settings.getErrors('maxTotalLogSize'),
}) }}
